name: Cleanup Docker Images

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  DOCKERHUB_USERNAME: idobet21
  KEEP_IMAGES: 5  # Keep only the last 5 images per service

jobs:
  cleanup:
    name: Cleanup ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [webhook-handler, worker]

    steps:
      - name: Get Docker Hub JWT Token
        id: auth
        run: |
          TOKEN=$(curl -s -X POST "https://hub.docker.com/v2/users/login" \
            -H "Content-Type: application/json" \
            -d '{"username": "${{ env.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            | jq -r '.token')
          
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ Failed to authenticate with Docker Hub"
            exit 1
          fi
          echo "✅ Authenticated with Docker Hub"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Get all digests for ${{ matrix.service }}
        id: get-digests
        run: |
          REPO="${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}"
          
          # Get all images with their digests and tags, sorted by last_pushed (newest first)
          IMAGES=$(curl -s "https://hub.docker.com/v2/repositories/$REPO/tags/?page_size=100" \
            | jq -r '.results | sort_by(.last_pushed) | reverse | .[].digest' \
            | uniq)
          
          TOTAL=$(echo "$IMAGES" | grep -c . || echo "0")
          echo "total_images=$TOTAL" >> $GITHUB_OUTPUT
          
          # Get the digest of 'latest' tag to always preserve it
          LATEST_DIGEST=$(curl -s "https://hub.docker.com/v2/repositories/$REPO/tags/latest" \
            | jq -r '.digest // empty')
          
          echo "Latest digest: $LATEST_DIGEST"
          
          # Keep first N unique digests plus the latest digest
          KEEP_DIGESTS=$(echo "$IMAGES" | head -n ${{ env.KEEP_IMAGES }})
          if [ -n "$LATEST_DIGEST" ]; then
            KEEP_DIGESTS=$(echo -e "$KEEP_DIGESTS\n$LATEST_DIGEST" | sort -u)
          fi
          
          # Find digests to delete (not in keep list)
          TO_DELETE=""
          for digest in $IMAGES; do
            if ! echo "$KEEP_DIGESTS" | grep -q "^$digest$"; then
              TO_DELETE="$TO_DELETE$digest"$'\n'
            fi
          done
          TO_DELETE=$(echo "$TO_DELETE" | sed '/^$/d')
          
          if [ -z "$TO_DELETE" ]; then
            echo "No images to delete (only $TOTAL images exist, keeping ${{ env.KEEP_IMAGES }})"
            echo "should_delete=false" >> $GITHUB_OUTPUT
            echo "to_delete_count=0" >> $GITHUB_OUTPUT
          else
            COUNT=$(echo "$TO_DELETE" | grep -c . || echo "0")
            echo "Will delete $COUNT old images"
            echo "should_delete=true" >> $GITHUB_OUTPUT
            echo "to_delete_count=$COUNT" >> $GITHUB_OUTPUT
            echo "digests<<EOF" >> $GITHUB_OUTPUT
            echo "$TO_DELETE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Delete old images for ${{ matrix.service }}
        id: delete
        if: steps.get-digests.outputs.should_delete == 'true'
        run: |
          REPO="${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}"
          TOKEN="${{ steps.auth.outputs.token }}"
          DELETED=0
          FAILED=0
          
          echo "Deleting old images for ${{ matrix.service }}..."
          
          while read digest; do
            if [ -z "$digest" ]; then continue; fi
            
            echo "Deleting digest: ${digest:0:20}..."
            
            # Delete by digest using the manifests endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              -H "Authorization: Bearer $TOKEN" \
              "https://hub.docker.com/v2/repositories/$REPO/images/$digest")
            
            if [ "$HTTP_CODE" = "202" ] || [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Deleted ${digest:0:20}..."
              DELETED=$((DELETED + 1))
            else
              echo "❌ Failed to delete ${digest:0:20}... (HTTP $HTTP_CODE)"
              FAILED=$((FAILED + 1))
            fi
            
            sleep 0.5  # Rate limit protection
          done <<< "${{ steps.get-digests.outputs.digests }}"
          
          echo "deleted_count=$DELETED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### Cleanup Summary for ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total images found | ${{ steps.get-digests.outputs.total_images }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Images kept | ${{ env.KEEP_IMAGES }} + latest |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.get-digests.outputs.should_delete }}" = "true" ]; then
            echo "| Images deleted | ${{ steps.delete.outputs.deleted_count || '0' }} ✅ |" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.delete.outputs.failed_count }}" != "0" ] && [ -n "${{ steps.delete.outputs.failed_count }}" ]; then
              echo "| Failed to delete | ${{ steps.delete.outputs.failed_count }} ❌ |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Images deleted | 0 (no cleanup needed) |" >> $GITHUB_STEP_SUMMARY
          fi
