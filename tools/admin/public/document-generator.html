<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Generator - Invofox Admin</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="style.css">
  <style>
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    .doc-type-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .doc-type-card {
      background: var(--bg-card);
      padding: 30px;
      border-radius: var(--radius-lg);
      border: 2px solid var(--border);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .doc-type-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--primary-glow);
    }

    .doc-type-card.active {
      border-color: var(--primary);
      background: rgba(129, 140, 248, 0.1);
      box-shadow: 0 0 20px var(--primary-glow);
    }

    .doc-type-icon {
      font-size: 48px;
      margin-bottom: 15px;
      filter: grayscale(0.3);
    }

    .doc-type-card.active .doc-type-icon {
      filter: grayscale(0);
    }

    .doc-type-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .doc-type-desc {
      font-size: 13px;
      color: var(--text-muted);
    }

    .main-content {
      display: none;
    }

    .main-content.visible {
      display: block;
    }

    .alert-info {
      background: rgba(129, 140, 248, 0.1);
      border: 1px solid var(--primary);
      border-radius: var(--radius);
      padding: 15px 20px;
      margin-bottom: 20px;
      color: var(--text-secondary);
      direction: rtl;
      text-align: right;
    }

    .alert-info strong {
      color: var(--primary-light);
    }

    .form-section {
      margin-bottom: 30px;
    }

    .modern-input,
    .modern-select,
    .modern-textarea {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
      font-family: inherit;
      direction: rtl;
      text-align: right;
    }

    .modern-select option {
      background: #ffffff;
      color: #000000;
      padding: 8px;
      direction: rtl;
    }

    /* Autocomplete dropdown */
    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--primary);
      border-radius: var(--radius);
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      direction: rtl;
      text-align: right;
      transition: var(--transition);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: rgba(129, 140, 248, 0.2);
      color: var(--primary-light);
    }

    .autocomplete-empty {
      padding: 12px 16px;
      color: var(--text-muted);
      text-align: center;
      direction: rtl;
    }

    .modern-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .modern-input:focus,
    .modern-select:focus,
    .modern-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-glow);
    }

    .modern-input::placeholder {
      color: var(--text-muted);
    }

    /* White calendar icon for date inputs */
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    /* Dropdown toggle button hover effect */
    #business_dropdown_toggle:hover {
      color: var(--primary) !important;
    }

    #business_dropdown_toggle svg {
      transition: transform 0.2s ease;
    }

    #business_dropdown_toggle:hover svg {
      transform: translateY(2px);
    }

    .form-group {
      margin-bottom: 20px;
      direction: rtl;
      text-align: right;
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
      direction: rtl;
    }

    .form-row .form-group {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
    }

    .help-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
      direction: rtl;
      text-align: right;
    }

    .card-header {
      direction: rtl;
      text-align: right;
    }

    .card-header h3 {
      direction: rtl;
      text-align: right;
    }

    .card-body {
      direction: rtl;
    }

    @media (max-width: 968px) {
      .doc-type-selector {
        grid-template-columns: 1fr;
      }
    }

    /* Two Column Layout */
    .two-column-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
      align-items: stretch;
    }

    @media (max-width: 1200px) {
      .two-column-layout {
        grid-template-columns: 1fr;
      }
    }

    .preview-side {
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .form-side {
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .preview-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .form-side .card {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .preview-title {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
    }

    .preview-content {
      padding: 30px;
      background: white;
      flex: 1;
      font-family: 'Heebo', Arial, sans-serif;
      direction: rtl;
      color: #333;
      font-size: 13px;
      line-height: 1.6;
      overflow-y: auto;
    }

    .preview-content .doc-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 15px;
      border-bottom: 2px solid #2563eb;
      margin-bottom: 15px;
    }

    .preview-content .business-info {
      text-align: right;
      font-size: 11px;
      color: #555;
    }

    .preview-content .business-name {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 3px;
    }

    .preview-content .logo-placeholder {
      width: 80px;
      height: 80px;
      background: #f0f0f0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
    }

    .preview-content .title-bar {
      background: #2563eb;
      color: white;
      text-align: center;
      padding: 10px 15px;
      margin: 15px 0;
      font-size: 16px;
      font-weight: 700;
      border-radius: 4px;
    }

    .preview-content .meta-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid #ddd;
      font-size: 11px;
    }

    .preview-content .customer-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .preview-content .customer-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .preview-content .items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 12px;
    }

    .preview-content .items-table th {
      background: #f1f5f9;
      padding: 8px 10px;
      text-align: right;
      font-weight: 600;
      border: 1px solid #ddd;
    }

    .preview-content .items-table td {
      padding: 8px 10px;
      text-align: right;
      border: 1px solid #ddd;
    }

    .preview-content .total-row {
      background: #f8f9fa;
      font-weight: 700;
    }

    .preview-content .amount {
      color: #2563eb;
      font-weight: 700;
    }

    .preview-content .related-invoice {
      background: #eff6ff;
      border-right: 4px solid #2563eb;
      padding: 10px 12px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 12px;
    }

    .preview-content .footer {
      margin-top: 40px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #666;
    }

    .preview-placeholder {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .preview-placeholder svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Invoice search styling */
    #rec_invoiceSearch {
      border: 2px solid var(--primary);
      background: var(--bg-secondary);
    }

    #rec_invoiceSearch:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px var(--primary-glow);
    }

    #rec_invoiceSearch::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Invoice select enhanced */
    #rec_invoiceNumber option {
      padding: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    #rec_invoiceNumber option:first-child {
      font-family: inherit;
      font-style: italic;
      color: var(--text-muted);
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header">
        <h2>
          <svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Document Generator
        </h2>
        <p style="color: var(--text-muted); font-size: 14px; margin-top: 8px;">
          ×™×™×¦×•×¨ ×—×©×‘×•× ×™×•×ª, ×§×‘×œ×•×ª ×•×—×©×‘×•× ×™×•×ª-×§×‘×œ×”
        </p>
      </div>
    </div>

    <!-- Business Selection (Global) -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header" style="background: rgba(129, 140, 248, 0.1); border-bottom: 2px solid var(--primary);">
        <h3 style="font-size: 16px; color: var(--primary-light); direction: rtl;">
          ğŸ¢ ×‘×—×¨ ×¢×¡×§
        </h3>
      </div>
      <div class="card-body">
        <div class="form-group" style="margin-bottom: 0;">
          <div style="position: relative;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <div style="position: relative; flex: 1;">
                <div style="position: relative; display: flex; align-items: center;">
                  <input
                    type="text"
                    class="modern-input"
                    id="global_business_search"
                    placeholder="×—×¤×© ××• ×‘×—×¨ ×¢×¡×§..."
                    autocomplete="off"
                    style="width: 100%; padding-left: 40px;">
                  <button
                    type="button"
                    id="business_dropdown_toggle"
                    style="position: absolute; left: 8px; background: none; border: none; cursor: pointer; padding: 4px 8px; color: var(--text-secondary); transition: var(--transition);"
                    title="×”×¦×’ ××ª ×›×œ ×”×¢×¡×§×™×">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                </div>
                <input type="hidden" id="global_business" value="">
                <div id="business_dropdown" class="autocomplete-dropdown" style="display: none;"></div>
              </div>
              <button type="button" class="btn btn-secondary" id="global_refresh_business" title="×¨×¢× ×Ÿ ×¨×©×™××ª ×¢×¡×§×™×">
                <svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="help-text" style="direction: rtl; text-align: right;">
            ×‘×—×¨ ××ª ×”×¢×¡×§ ×©×¢×‘×•×¨×• ×‘×¨×¦×•× ×š ×œ×™×¦×•×¨ ××¡××›×™× (×–×” ×œ× ×”×œ×§×•×— ×©×œ×š, ××œ× ×”×¢×¡×§ ×©×œ×š ×‘-Invofox)
          </div>
        </div>
      </div>
    </div>

    <!-- Document Type Selector -->
    <div class="doc-type-selector">
      <div class="doc-type-card" data-type="invoice">
        <div class="doc-type-icon">ğŸ“‹</div>
        <div class="doc-type-title">×—×©×‘×•× ×™×ª</div>
        <div class="doc-type-desc">×ª×©×œ×•× ×××ª×™×Ÿ ××• ×—×œ×§×™</div>
      </div>

      <div class="doc-type-card" data-type="receipt">
        <div class="doc-type-icon">ğŸ§¾</div>
        <div class="doc-type-title">×§×‘×œ×”</div>
        <div class="doc-type-desc">××™×©×•×¨ ×ª×©×œ×•× ×¢×œ ×—×©×‘×•× ×™×ª ×§×™×™××ª</div>
      </div>

      <div class="doc-type-card" data-type="invoice_receipt">
        <div class="doc-type-icon">ğŸ’³</div>
        <div class="doc-type-title">×—×©×‘×•× ×™×ª-×§×‘×œ×”</div>
        <div class="doc-type-desc">××¡××š ××©×•×œ×‘ - ×ª×©×œ×•× ××™×™×“×™</div>
      </div>
    </div>

    <!-- Invoice Form -->
    <div id="invoice-content" class="main-content">
      <div class="alert-info">
        <strong>×—×©×‘×•× ×™×ª:</strong> ××©××©×ª ×›××©×¨ ×”×ª×©×œ×•× ×˜×¨× ×”×ª×§×‘×œ ××• ×”×ª×§×‘×œ ×—×œ×§×™×ª
      </div>

      <div class="two-column-layout">
        <div class="preview-side">
          <div class="preview-box">
            <div class="preview-title">×ª×¦×•×’×” ××§×“×™××”</div>
            <div id="invoice-preview" class="preview-content"></div>
          </div>
        </div>

        <div class="form-side">
      <div class="card">
        <div class="card-header">
          <h3>×¤×¨×˜×™ ×—×©×‘×•× ×™×ª</h3>
        </div>
        <div class="card-body">
          <form id="invoiceForm">
            <div class="form-group">
              <label>×©× ×”×œ×§×•×— (××§×‘×œ ×”×—×©×‘×•× ×™×ª) *</label>
              <input type="text" class="modern-input" id="inv_customerName" placeholder="×©× ×”×—×‘×¨×” ××• ×”××“× ×”×¤×¨×˜×™" required>
              <div class="help-text">×”×œ×§×•×— ×©×œ×š ×©××§×‘×œ ××ª ×”×—×©×‘×•× ×™×ª</div>
            </div>
            <div class="form-group">
              <label>×—.×¤ / ×¢.× (××•×¤×¦×™×•× ×œ×™)</label>
              <input type="text" class="modern-input" id="inv_customerTaxId" placeholder="123456789">
            </div>
            <div class="form-group">
              <label>×ª×™××•×¨ ×”×©×™×¨×•×ª/××•×¦×¨ *</label>
              <textarea class="modern-textarea" id="inv_description" placeholder="×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”×©×™×¨×•×ª ××• ×”××•×¦×¨..." required></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>×¡×›×•× *</label>
                <input type="number" class="modern-input" id="inv_amount" step="0.01" placeholder="1000.00" required>
              </div>
              <div class="form-group">
                <label>××˜×‘×¢ *</label>
                <select class="modern-select" id="inv_currency" required>
                  <option value="ILS" selected>ILS â‚ª</option>
                  <option value="USD">USD $</option>
                  <option value="EUR">EUR â‚¬</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>×ª××¨×™×š ×—×©×‘×•× ×™×ª *</label>
              <input type="date" class="modern-input" id="inv_date" required>
              <div class="help-text">× ×™×ª×Ÿ ×’× ×œ×”×§×œ×™×“ ××ª ×”×ª××¨×™×š ×™×“× ×™×ª</div>
            </div>
            <button type="submit" class="btn btn-primary">
              <svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              <span>×¦×•×¨ ×—×©×‘×•× ×™×ª</span>
            </button>
          </form>
        </div>
      </div>
        </div>
      </div>
    </div>

    <!-- Receipt Form -->
    <div id="receipt-content" class="main-content">
      <div class="alert-info">
        <strong>×§×‘×œ×”:</strong> ×××©×¨×ª ×ª×©×œ×•× ×©×”×ª×§×‘×œ ×¢×œ ×—×©×‘×•× ×™×ª ×§×™×™××ª
      </div>

      <div class="two-column-layout">
        <div class="preview-side">
          <div class="preview-box">
            <div class="preview-title">×ª×¦×•×’×” ××§×“×™××”</div>
            <div id="receipt-preview" class="preview-content"></div>
          </div>
        </div>

        <div class="form-side">
      <div class="card">
        <div class="card-header">
          <h3>×¤×¨×˜×™ ×§×‘×œ×”</h3>
        </div>
        <div class="card-body">
          <form id="receiptForm">
            <div class="form-group">
              <label>×‘×—×¨ ×—×©×‘×•× ×™×ª ×¤×ª×•×—×” *</label>
              <input type="text" class="modern-input" id="rec_invoiceSearch" placeholder="×—×¤×© ×—×©×‘×•× ×™×ª..." disabled>
              <select class="modern-input" id="rec_invoiceNumber" required style="margin-top: 8px;">
                <option value="">×‘×—×¨ ×œ×§×•×— ×ª×—×™×œ×”</option>
              </select>
              <div class="help-text">××•×¦×’×•×ª ×¨×§ ×—×©×‘×•× ×™×•×ª ×©×œ× ×©×•×œ××• ×‘××œ×•××Ÿ</div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>×¡×›×•× ×ª×©×œ×•× *</label>
                <input type="number" class="modern-input" id="rec_amount" step="0.01" placeholder="300.00" required>
                <div class="help-text">×”×¡×›×•× ×©×”×ª×§×‘×œ</div>
              </div>
              <div class="form-group">
                <label>××˜×‘×¢ *</label>
                <select class="modern-select" id="rec_currency" required>
                  <option value="ILS" selected>ILS â‚ª</option>
                  <option value="USD">USD $</option>
                  <option value="EUR">EUR â‚¬</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>×××¦×¢×™ ×ª×©×œ×•× *</label>
              <select class="modern-input" id="rec_paymentMethod" required>
                <option value="">×‘×—×¨ ×××¦×¢×™ ×ª×©×œ×•×</option>
                <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                <option value="×‘×™×˜">×‘×™×˜</option>
                <option value="PayBox">PayBox</option>
                <option value="××©×¨××™">××©×¨××™</option>
                <option value="×¦×³×§">×¦×³×§</option>
              </select>
            </div>
            <div class="form-group">
              <label>×ª××¨×™×š ×§×‘×œ×” *</label>
              <input type="date" class="modern-input" id="rec_date" required>
              <div class="help-text">× ×™×ª×Ÿ ×’× ×œ×”×§×œ×™×“ ××ª ×”×ª××¨×™×š ×™×“× ×™×ª</div>
            </div>
            <button type="submit" class="btn btn-primary">
              <svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              <span>×¦×•×¨ ×§×‘×œ×”</span>
            </button>
          </form>
        </div>
      </div>
        </div>
      </div>
    </div>

    <!-- Invoice-Receipt Form -->
    <div id="invoice_receipt-content" class="main-content">
      <div class="alert-info">
        <strong>×—×©×‘×•× ×™×ª-×§×‘×œ×”:</strong> ××¡××š ××©×•×œ×‘ ×›××©×¨ ×”×ª×©×œ×•× ××ª×§×‘×œ ××™×™×“×™×ª
      </div>

      <div class="two-column-layout">
        <div class="preview-side">
          <div class="preview-box">
            <div class="preview-title">×ª×¦×•×’×” ××§×“×™××”</div>
            <div id="invoice_receipt-preview" class="preview-content"></div>
          </div>
        </div>

        <div class="form-side">
      <div class="card">
        <div class="card-header">
          <h3>×¤×¨×˜×™ ×—×©×‘×•× ×™×ª-×§×‘×œ×”</h3>
        </div>
        <div class="card-body">
          <form id="invoiceReceiptForm">
            <div class="form-group">
              <label>×©× ×”×œ×§×•×— (××§×‘×œ ×”××¡××š) *</label>
              <input type="text" class="modern-input" id="invr_customerName" placeholder="×©× ×”×—×‘×¨×” ××• ×”××“× ×”×¤×¨×˜×™" required>
              <div class="help-text">×”×œ×§×•×— ×©×œ×š ×©××§×‘×œ ××ª ×”×—×©×‘×•× ×™×ª-×§×‘×œ×”</div>
            </div>
            <div class="form-group">
              <label>×—.×¤ / ×¢.× (××•×¤×¦×™×•× ×œ×™)</label>
              <input type="text" class="modern-input" id="invr_customerTaxId" placeholder="123456789">
            </div>
            <div class="form-group">
              <label>×ª×™××•×¨ ×”×©×™×¨×•×ª/××•×¦×¨ *</label>
              <textarea class="modern-textarea" id="invr_description" placeholder="×ª×™××•×¨ ××¤×•×¨×˜ ×©×œ ×”×©×™×¨×•×ª ××• ×”××•×¦×¨..." required></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>×¡×›×•× *</label>
                <input type="number" class="modern-input" id="invr_amount" step="0.01" placeholder="1000.00" required>
              </div>
              <div class="form-group">
                <label>××˜×‘×¢ *</label>
                <select class="modern-select" id="invr_currency" required>
                  <option value="ILS" selected>ILS â‚ª</option>
                  <option value="USD">USD $</option>
                  <option value="EUR">EUR â‚¬</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>×××¦×¢×™ ×ª×©×œ×•× *</label>
              <select class="modern-input" id="invr_paymentMethod" required>
                <option value="">×‘×—×¨ ×××¦×¢×™ ×ª×©×œ×•×</option>
                <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                <option value="×”×¢×‘×¨×” ×‘× ×§××™×ª">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                <option value="×‘×™×˜">×‘×™×˜</option>
                <option value="PayBox">PayBox</option>
                <option value="××©×¨××™">××©×¨××™</option>
                <option value="×¦×³×§">×¦×³×§</option>
              </select>
            </div>
            <div class="form-group">
              <label>×ª××¨×™×š *</label>
              <input type="date" class="modern-input" id="invr_date" required>
              <div class="help-text">× ×™×ª×Ÿ ×’× ×œ×”×§×œ×™×“ ××ª ×”×ª××¨×™×š ×™×“× ×™×ª</div>
            </div>
            <button type="submit" class="btn btn-primary">
              <svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              <span>×¦×•×¨ ×—×©×‘×•× ×™×ª-×§×‘×œ×”</span>
            </button>
          </form>
        </div>
      </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getCachedCustomers, getCachedInvoicesForCustomer, clearCustomerCache, clearInvoiceCacheForCustomer } from './js/cache.js';
    import { generateInvoice, generateReceipt, generateInvoiceReceipt } from './js/document-api.js';
    import { showSuccess, showError } from './js/utils.js';

    let selectedDocType = null;
    let selectedBusiness = null;  // The Invofox business user
    let selectedInvoice = null;

    // Select document type
    function selectDocType(type, cardElement) {
      console.log('Selecting doc type:', type);
      selectedDocType = type;

      // Update card styles
      document.querySelectorAll('.doc-type-card').forEach(card => {
        card.classList.remove('active');
      });
      if (cardElement) {
        cardElement.classList.add('active');
      }

      // Hide all content
      document.querySelectorAll('.main-content').forEach(content => {
        content.classList.remove('visible');
      });

      // Show selected content
      const contentId = `${type}-content`;
      console.log('Looking for content element:', contentId);
      const contentElement = document.getElementById(contentId);
      if (contentElement) {
        contentElement.classList.add('visible');
        console.log('Content element found and visible class added');
      } else {
        console.error('Content element not found:', contentId);
      }
    }

    // Initialize preview listeners first
    setupPreviewListeners();

    // Add click listeners to document type cards
    document.querySelectorAll('.doc-type-card').forEach(card => {
      card.addEventListener('click', function() {
        const type = this.getAttribute('data-type');
        selectDocType(type, this);
        // Update preview after selecting document type
        setTimeout(updatePreview, 100);
      });
    });

    // Set today as default date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inv_date').value = today;
    document.getElementById('rec_date').value = today;
    document.getElementById('invr_date').value = today;

    // Add manual date typing support with format hints
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
      input.setAttribute('pattern', '\\d{4}-\\d{2}-\\d{2}');
      input.setAttribute('placeholder', 'YYYY-MM-DD');
    });

    // ============================================================================
    // GLOBAL BUSINESS SELECTION (AUTOCOMPLETE)
    // ============================================================================

    let allBusinesses = [];
    let filteredBusinesses = [];

    async function loadBusinesses(forceRefresh = false) {
      const searchInput = document.getElementById('global_business_search');
      const hiddenInput = document.getElementById('global_business');

      searchInput.disabled = true;
      searchInput.placeholder = '×˜×•×¢×Ÿ ×¢×¡×§×™×...';

      try {
        console.log('Loading businesses...');
        allBusinesses = await getCachedCustomers(forceRefresh);
        filteredBusinesses = [...allBusinesses];
        console.log('Businesses loaded:', allBusinesses);

        searchInput.placeholder = `×—×¤×© ××• ×‘×—×¨ ×¢×¡×§... (${allBusinesses.length} ×¢×¡×§×™×)`;

        // Set default business (remember last selection or use first one)
        const lastSelectedChatId = localStorage.getItem('invofox_selected_business');
        let defaultBusiness = null;

        // Try to restore last selected business
        if (lastSelectedChatId) {
          defaultBusiness = allBusinesses.find(b => b.chatId.toString() === lastSelectedChatId);
          console.log('Restoring last selected business:', defaultBusiness?.name);
        }

        // If no saved selection or business no longer exists, use first one
        if (!defaultBusiness && allBusinesses.length > 0) {
          defaultBusiness = allBusinesses[0];
          console.log('Using first business as default:', defaultBusiness.name);
        }

        if (defaultBusiness) {
          searchInput.value = defaultBusiness.name;
          hiddenInput.value = defaultBusiness.chatId;
          await onBusinessSelected(defaultBusiness.chatId);
        }

        searchInput.disabled = false;
      } catch (error) {
        console.error('Failed to load businesses:', error);
        alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×¢×¡×§×™×: ${error.message}\n\n×¤×ª×— ××ª Developer Console ×œ×¤×¨×˜×™× × ×•×¡×¤×™× (F12)`);
        searchInput.placeholder = `×©×’×™××”: ${error.message}`;
      }
    }

    function showBusinessDropdown(businesses) {
      const dropdown = document.getElementById('business_dropdown');
      dropdown.innerHTML = '';

      if (businesses.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-empty">×œ× × ××¦××• ×¢×¡×§×™×</div>';
        dropdown.style.display = 'block';
        return;
      }

      businesses.forEach(business => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = business.name;
        item.dataset.chatId = business.chatId;
        item.dataset.business = JSON.stringify(business);

        item.addEventListener('click', () => selectBusiness(business));

        dropdown.appendChild(item);
      });

      dropdown.style.display = 'block';
    }

    function hideBusinessDropdown() {
      setTimeout(() => {
        document.getElementById('business_dropdown').style.display = 'none';
      }, 200);
    }

    function selectBusiness(business) {
      const searchInput = document.getElementById('global_business_search');
      const hiddenInput = document.getElementById('global_business');

      searchInput.value = business.name;
      hiddenInput.value = business.chatId;

      hideBusinessDropdown();

      // Save selection
      localStorage.setItem('invofox_selected_business', business.chatId);

      onBusinessSelected(business.chatId);
    }

    // Autocomplete event listeners
    const businessSearchInput = document.getElementById('global_business_search');

    businessSearchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();

      if (searchTerm === '') {
        filteredBusinesses = [...allBusinesses];
      } else {
        filteredBusinesses = allBusinesses.filter(business =>
          business.name.toLowerCase().includes(searchTerm)
        );
      }

      showBusinessDropdown(filteredBusinesses);
    });

    businessSearchInput.addEventListener('focus', () => {
      if (allBusinesses.length > 0) {
        showBusinessDropdown(filteredBusinesses);
      }
    });

    businessSearchInput.addEventListener('blur', () => {
      hideBusinessDropdown();
    });

    // Dropdown toggle button
    document.getElementById('business_dropdown_toggle').addEventListener('mousedown', (e) => {
      e.preventDefault(); // Prevent input from losing focus
    });

    document.getElementById('business_dropdown_toggle').addEventListener('click', () => {
      const dropdown = document.getElementById('business_dropdown');
      const searchInput = document.getElementById('global_business_search');

      if (dropdown.style.display === 'block') {
        // Close dropdown
        hideBusinessDropdown();
      } else {
        // Open dropdown with all businesses
        searchInput.focus();
        filteredBusinesses = [...allBusinesses];
        showBusinessDropdown(filteredBusinesses);
      }
    });

    async function onBusinessSelected(chatId) {
      const invoiceSelect = document.getElementById('rec_invoiceNumber');
      const searchInput = document.getElementById('rec_invoiceSearch');

      if (!chatId) {
        // Clear everything
        selectedBusiness = null;
        invoiceSelect.innerHTML = '<option value="">×‘×—×¨ ×¢×¡×§ ×ª×—×™×œ×”</option>';
        invoiceSelect.disabled = true;
        searchInput.disabled = true;
        searchInput.value = '';
        BUSINESS_NAME = '';
        BUSINESS_TAX_ID = '';
        BUSINESS_TAX_STATUS = '';
        BUSINESS_EMAIL = '';
        BUSINESS_ADDRESS = '';
        BUSINESS_PHONE = '';
        BUSINESS_LOGO = '';
        updatePreview();
        return;
      }

      // Get business data from allBusinesses array
      selectedBusiness = allBusinesses.find(b => b.chatId === chatId);

      if (selectedBusiness) {
        // Update business details for preview and forms
        BUSINESS_NAME = selectedBusiness.name || '';
        BUSINESS_TAX_ID = selectedBusiness.taxId || '';
        BUSINESS_TAX_STATUS = selectedBusiness.taxStatus || '×¢×•×¡×§ ×¤×˜×•×¨ ××¡';
        BUSINESS_EMAIL = selectedBusiness.email || '';
        BUSINESS_ADDRESS = selectedBusiness.address || '';
        BUSINESS_PHONE = selectedBusiness.phone || '';
        BUSINESS_LOGO = selectedBusiness.logoUrl || selectedBusiness.logo || '';
      }

      // Load invoices for this business
      invoiceSelect.disabled = true;
      searchInput.disabled = true;
      invoiceSelect.innerHTML = '<option value="">×˜×•×¢×Ÿ ×—×©×‘×•× ×™×•×ª...</option>';

      try {
        const invoices = await getCachedInvoicesForCustomer(chatId);

        // Store all invoices for filtering
        invoiceSelect.dataset.allInvoices = JSON.stringify(invoices);

        const renderInvoiceOptions = (filteredInvoices) => {
          invoiceSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×—×©×‘×•× ×™×ª --</option>';

          if (filteredInvoices.length === 0) {
            invoiceSelect.innerHTML = '<option value="">××™×Ÿ ×—×©×‘×•× ×™×•×ª ×¤×ª×•×—×•×ª ×œ×œ×§×•×— ×–×”</option>';
          } else {
            filteredInvoices.forEach(invoice => {
              const option = document.createElement('option');
              option.value = invoice.invoiceNumber;

              // Format status in Hebrew
              const statusMap = {
                'unpaid': '×œ× ×©×•×œ×',
                'partial': '×©×•×œ× ×—×œ×§×™×ª',
                'paid': '×©×•×œ× ×‘××œ×•××•'
              };
              const statusText = statusMap[invoice.paymentStatus] || invoice.paymentStatus;

              // Format: ×—×©×‘×•× ×™×ª 20261 | â‚ª500.00 ×™×ª×¨×” | ×œ× ×©×•×œ× | 28/01/2026
              option.textContent = `×—×©×‘×•× ×™×ª ${invoice.invoiceNumber} | ×™×ª×¨×”: â‚ª${invoice.remainingBalance.toFixed(2)} | ${statusText} | ${invoice.date || ''}`;
              option.dataset.invoice = JSON.stringify(invoice);
              invoiceSelect.appendChild(option);
            });
          }
        };

        // Initial render
        renderInvoiceOptions(invoices);

        // Enable search
        searchInput.disabled = false;
        searchInput.value = '';
        searchInput.placeholder = `×—×¤×© ×—×©×‘×•× ×™×ª... (${invoices.length} ×—×©×‘×•× ×™×•×ª ×–××™× ×•×ª)`;

        // Search functionality
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const allInvoices = JSON.parse(invoiceSelect.dataset.allInvoices || '[]');

          const filtered = allInvoices.filter(invoice => {
            return (
              invoice.invoiceNumber.toLowerCase().includes(searchTerm) ||
              invoice.customerName?.toLowerCase().includes(searchTerm) ||
              invoice.description?.toLowerCase().includes(searchTerm) ||
              invoice.amount.toString().includes(searchTerm) ||
              invoice.date?.includes(searchTerm)
            );
          });

          renderInvoiceOptions(filtered);
        });

        invoiceSelect.disabled = false;
      } catch (error) {
        console.error('Failed to load invoices:', error);
        invoiceSelect.innerHTML = '<option value="">×©×’×™××” ×‘×˜×¢×™× ×ª ×—×©×‘×•× ×™×•×ª</option>';
        searchInput.disabled = true;
      }

      // Update preview
      updatePreview();
    }

    function onInvoiceSelected() {
      const invoiceSelect = document.getElementById('rec_invoiceNumber');
      const option = invoiceSelect.selectedOptions[0];

      if (option && option.dataset.invoice) {
        selectedInvoice = JSON.parse(option.dataset.invoice);

        // Auto-fill payment amount with remaining balance
        const amountInput = document.getElementById('rec_amount');
        if (selectedInvoice.remainingBalance) {
          amountInput.value = selectedInvoice.remainingBalance.toFixed(2);
          // Set max attribute to prevent overpayment
          amountInput.max = selectedInvoice.remainingBalance.toFixed(2);
        }

        // Set currency
        const currencySelect = document.getElementById('rec_currency');
        if (selectedInvoice.currency) {
          currencySelect.value = selectedInvoice.currency;
        }
      } else {
        selectedInvoice = null;
        // Remove max if no invoice selected
        const amountInput = document.getElementById('rec_amount');
        amountInput.removeAttribute('max');
      }

      updatePreview();
    }

    // Invoice selection event listener
    document.getElementById('rec_invoiceNumber').addEventListener('change', onInvoiceSelected);

    // Real-time validation for receipt amount
    document.getElementById('rec_amount').addEventListener('input', function(e) {
      const amount = parseFloat(e.target.value) || 0;
      const remainingBalance = selectedInvoice?.remainingBalance || 0;
      const submitBtn = document.querySelector('#receiptForm button[type="submit"]');

      // Remove any existing error message
      const existingError = document.getElementById('rec_amount_error');
      if (existingError) existingError.remove();

      if (amount > remainingBalance && selectedInvoice) {
        // Add error styling
        e.target.style.borderColor = '#ef4444';
        e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';

        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.id = 'rec_amount_error';
        errorDiv.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 5px; direction: rtl; text-align: right;';
        errorDiv.textContent = `×”×¡×›×•× ×’×‘×•×” ××“×™! ×™×ª×¨×” ×œ×ª×©×œ×•×: â‚ª${remainingBalance.toFixed(2)}`;
        e.target.parentElement.appendChild(errorDiv);

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
      } else {
        // Remove error styling
        e.target.style.borderColor = '';
        e.target.style.boxShadow = '';

        // Enable submit button
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      }

      updatePreview();
    });

    // Global refresh button
    document.getElementById('global_refresh_business').addEventListener('click', async () => {
      const btn = document.getElementById('global_refresh_business');
      const refreshIcon = '<svg class="icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';
      const spinIcon = '<svg class="icon-inline spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';

      btn.disabled = true;
      btn.innerHTML = spinIcon;

      try {
        clearCustomerCache();
        const currentChatId = document.getElementById('global_business').value;
        if (currentChatId) {
          clearInvoiceCacheForCustomer(currentChatId);
        }
        await loadBusinesses(true);
      } finally {
        btn.disabled = false;
        btn.innerHTML = refreshIcon;
      }
    });

    // Load businesses on page load
    loadBusinesses();

    // ============================================================================
    // PDF DOWNLOAD HELPER
    // ============================================================================

    /**
     * Download PDF file from URL
     */
    async function downloadPDF(url, filename) {
      console.log('Downloading PDF from:', url);

      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Failed to download PDF: ${response.statusText}`);
      }

      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(downloadUrl);

      console.log('PDF downloaded successfully:', filename);
    }

    // ============================================================================
    // FORM SUBMISSION HANDLERS
    // ============================================================================

    document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate business selection
      if (!selectedBusiness || !selectedBusiness.chatId) {
        showError('×× × ×‘×—×¨ ×¢×¡×§ ×ª×—×™×œ×”');
        return;
      }

      // Get form data
      const formData = {
        chatId: selectedBusiness.chatId,
        customerName: document.getElementById('inv_customerName').value.trim(),
        customerTaxId: document.getElementById('inv_customerTaxId').value.trim() || undefined,
        description: document.getElementById('inv_description').value.trim(),
        amount: parseFloat(document.getElementById('inv_amount').value),
        currency: document.getElementById('inv_currency').value,
        date: document.getElementById('inv_date').value,
      };

      // Validate
      if (!formData.customerName || !formData.description || !formData.amount || !formData.date) {
        showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
        return;
      }

      // Disable submit button
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalBtnHtml = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <svg class="icon-inline spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        <span>×™×•×¦×¨ ×—×©×‘×•× ×™×ª...</span>
      `;

      try {
        const result = await generateInvoice(formData);

        // Show success message
        showSuccess(`×—×©×‘×•× ×™×ª ${result.invoiceNumber} × ×•×¦×¨×” ×‘×”×¦×œ×—×”! ××•×¨×™×“ PDF...`);

        // Download PDF automatically
        if (result.pdfUrl) {
          try {
            await downloadPDF(result.pdfUrl, `×—×©×‘×•× ×™×ª_${result.invoiceNumber}.pdf`);
            showSuccess(`×—×©×‘×•× ×™×ª ${result.invoiceNumber} × ×•×¦×¨×” ×•×”×•×¨×“×” ×‘×”×¦×œ×—×”!`);
          } catch (downloadError) {
            console.error('PDF download failed:', downloadError);
            showError(`×—×©×‘×•× ×™×ª × ×•×¦×¨×” ××š ×”×”×•×¨×“×” × ×›×©×œ×”. ${result.pdfUrl}`);
          }
        }

        // Clear form
        document.getElementById('invoiceForm').reset();
        document.getElementById('inv_date').value = today;

        // Refresh invoice cache for this business (so it appears in receipt dropdown)
        clearInvoiceCacheForCustomer(selectedBusiness.chatId);
        await onBusinessSelected(selectedBusiness.chatId);

        // Update preview
        updatePreview();

        console.log('Invoice created:', result);
      } catch (error) {
        console.error('Failed to generate invoice:', error);
        showError(`×©×’×™××” ×‘×™×¦×™×¨×ª ×—×©×‘×•× ×™×ª: ${error.message}`);
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHtml;
      }
    });

    document.getElementById('receiptForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate business selection
      if (!selectedBusiness || !selectedBusiness.chatId) {
        showError('×× × ×‘×—×¨ ×¢×¡×§ ×ª×—×™×œ×”');
        return;
      }

      // Validate invoice selection
      if (!selectedInvoice || !selectedInvoice.invoiceNumber) {
        showError('×× × ×‘×—×¨ ×—×©×‘×•× ×™×ª ×ª×—×™×œ×”');
        return;
      }

      // Get form data
      const formData = {
        invoiceNumber: selectedInvoice.invoiceNumber,
        paymentAmount: parseFloat(document.getElementById('rec_amount').value),
        paymentMethod: document.getElementById('rec_paymentMethod').value,
        date: document.getElementById('rec_date').value,
      };

      // Validate
      if (!formData.paymentAmount || !formData.paymentMethod || !formData.date) {
        showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
        return;
      }

      // Validate payment amount doesn't exceed remaining balance
      if (formData.paymentAmount > selectedInvoice.remainingBalance) {
        showError(`×¡×›×•× ×”×ª×©×œ×•× (${formData.paymentAmount}) ×’×‘×•×” ××”×™×ª×¨×” ×œ×ª×©×œ×•× (${selectedInvoice.remainingBalance})`);
        return;
      }

      // Disable submit button
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalBtnHtml = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <svg class="icon-inline spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        <span>×™×•×¦×¨ ×§×‘×œ×”...</span>
      `;

      try {
        const result = await generateReceipt(formData);

        // Show success message with payment status
        const paymentStatus = result.invoiceUpdated.newPaymentStatus === 'paid'
          ? '×”×—×©×‘×•× ×™×ª ×©×•×œ××” ×‘××œ×•××”'
          : `× ×•×ª×¨×• ×œ×ª×©×œ×•×: â‚ª${result.invoiceUpdated.newRemainingBalance.toFixed(2)}`;
        showSuccess(`×§×‘×œ×” ${result.receiptNumber} × ×•×¦×¨×” ×‘×”×¦×œ×—×”! ${paymentStatus}`);

        // Download PDF automatically
        if (result.pdfUrl) {
          try {
            await downloadPDF(result.pdfUrl, `×§×‘×œ×”_${result.receiptNumber}.pdf`);
          } catch (downloadError) {
            console.error('PDF download failed:', downloadError);
          }
        }

        // Clear form (except business selection)
        document.getElementById('receiptForm').reset();
        document.getElementById('rec_date').value = today;
        document.getElementById('rec_invoiceNumber').value = '';
        selectedInvoice = null;

        // Refresh invoice cache (to update payment status)
        clearInvoiceCacheForCustomer(selectedBusiness.chatId);
        await onBusinessSelected(selectedBusiness.chatId);

        // Update preview
        updatePreview();

        console.log('Receipt created:', result);
      } catch (error) {
        console.error('Failed to generate receipt:', error);
        showError(`×©×’×™××” ×‘×™×¦×™×¨×ª ×§×‘×œ×”: ${error.message}`);
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHtml;
      }
    });

    document.getElementById('invoiceReceiptForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate business selection
      if (!selectedBusiness || !selectedBusiness.chatId) {
        showError('×× × ×‘×—×¨ ×¢×¡×§ ×ª×—×™×œ×”');
        return;
      }

      // Get form data
      const formData = {
        chatId: selectedBusiness.chatId,
        customerName: document.getElementById('invr_customerName').value.trim(),
        customerTaxId: document.getElementById('invr_customerTaxId').value.trim() || undefined,
        description: document.getElementById('invr_description').value.trim(),
        amount: parseFloat(document.getElementById('invr_amount').value),
        currency: document.getElementById('invr_currency').value,
        paymentMethod: document.getElementById('invr_paymentMethod').value,
        date: document.getElementById('invr_date').value,
      };

      // Validate
      if (!formData.customerName || !formData.description || !formData.amount || !formData.paymentMethod || !formData.date) {
        showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
        return;
      }

      // Disable submit button
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalBtnHtml = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <svg class="icon-inline spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        <span>×™×•×¦×¨ ×—×©×‘×•× ×™×ª-×§×‘×œ×”...</span>
      `;

      try {
        const result = await generateInvoiceReceipt(formData);

        // Show success message
        showSuccess(`×—×©×‘×•× ×™×ª-×§×‘×œ×” ${result.invoiceReceiptNumber} × ×•×¦×¨×” ×‘×”×¦×œ×—×”!`);

        // Download PDF automatically
        if (result.pdfUrl) {
          try {
            await downloadPDF(result.pdfUrl, `×—×©×‘×•× ×™×ª-×§×‘×œ×”_${result.invoiceReceiptNumber}.pdf`);
          } catch (downloadError) {
            console.error('PDF download failed:', downloadError);
          }
        }

        // Clear form
        document.getElementById('invoiceReceiptForm').reset();
        document.getElementById('invr_date').value = today;

        // Update preview
        updatePreview();

        console.log('Invoice-receipt created:', result);
      } catch (error) {
        console.error('Failed to generate invoice-receipt:', error);
        showError(`×©×’×™××” ×‘×™×¦×™×¨×ª ×—×©×‘×•× ×™×ª-×§×‘×œ×”: ${error.message}`);
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHtml;
      }
    });

    // ============================================================================
    // LIVE PREVIEW FUNCTIONALITY
    // ============================================================================

    // Business details - loaded from selected customer
    let BUSINESS_NAME = '';
    let BUSINESS_TAX_ID = '';
    let BUSINESS_TAX_STATUS = '';
    let BUSINESS_EMAIL = '';
    let BUSINESS_ADDRESS = '';
    let BUSINESS_PHONE = '';
    let BUSINESS_LOGO = '';

    function getBusinessLogoHtml() {
      if (BUSINESS_LOGO) {
        return `<img src="${BUSINESS_LOGO}" alt="${BUSINESS_NAME}" style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px;">`;
      } else {
        return `<div class="logo-placeholder">ğŸ“„</div>`;
      }
    }

    function getCurrencySymbol(currency) {
      const symbols = {
        'ILS': 'â‚ª',
        'USD': '$',
        'EUR': 'â‚¬'
      };
      return symbols[currency] || 'â‚ª';
    }

    function formatAmount(amount, currency) {
      const symbol = getCurrencySymbol(currency);
      const num = parseFloat(amount) || 0;
      return `${symbol}${num.toFixed(2)}`;
    }

    function generateInvoicePreview() {
      const customerName = document.getElementById('inv_customerName').value || '×©× ×”×œ×§×•×—';
      const customerTaxId = document.getElementById('inv_customerTaxId').value || '0';
      const description = document.getElementById('inv_description').value || '×ª×™××•×¨ ×”×©×™×¨×•×ª';
      const amount = document.getElementById('inv_amount').value;
      const currency = document.getElementById('inv_currency').value;
      const date = document.getElementById('inv_date').value || new Date().toISOString().split('T')[0];
      const formattedDate = date.split('-').reverse().join('/');

      return `
        <div class="doc-header">
          <div class="business-info">
            <div class="business-name">${BUSINESS_NAME}</div>
            <p>${BUSINESS_TAX_STATUS}: ${BUSINESS_TAX_ID}</p>
            <p>${BUSINESS_EMAIL}</p>
            <p>×›×ª×•×‘×ª: ${BUSINESS_ADDRESS}</p>
            <p>${BUSINESS_PHONE}</p>
          </div>
          ${getBusinessLogoHtml()}
        </div>

        <div class="title-bar">×—×©×‘×•× ×™×ª / ××¡×³ [×™×•×§×¦×” ××•×˜×•××˜×™×ª]</div>

        <div class="meta-section">
          <div><span style="color: #666;">×¢×‘×•×¨:</span></div>
          <div><span style="color: #666;">××§×•×¨</span></div>
          <div><span style="color: #666;">×ª××¨×™×š: </span><strong>${formattedDate}</strong></div>
        </div>

        <div class="customer-info">
          <div class="customer-name">×©×: ${customerName}</div>
          <div style="font-size: 11px; color: #666;">×¢×•×¡×§ ××¡×³: ${customerTaxId}</div>
        </div>

        <table class="items-table">
          <thead>
            <tr>
              <th>×ª×™××•×¨</th>
              <th>×›××•×ª</th>
              <th>××—×™×¨ ×œ×™×—×™×“×”</th>
              <th>×¡×”×´×›</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${description}</td>
              <td>1</td>
              <td>${formatAmount(amount, currency)}</td>
              <td class="amount">${formatAmount(amount, currency)}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: center; font-weight: 700;">×¡×”×´×› ×œ×ª×©×œ×•×</td>
              <td class="amount">${formatAmount(amount, currency)}</td>
            </tr>
          </tbody>
        </table>

        <div class="footer">
          <div>×ª××¨×™×š ×”×¤×§×”: ${formattedDate}</div>
          <div style="text-align: left;">
            <div style="font-weight: 600; color: #333;">××¡××š ×××•×—×©×‘ ×—×ª×•× ×“×™×’×™×˜×œ×™×ª</div>
            <div>×”×•×¤×§ ×¢"×™ Invofox</div>
          </div>
        </div>
      `;
    }

    function generateReceiptPreview() {
      const invoiceNumber = document.getElementById('rec_invoiceNumber').value || '×œ× × ×‘×—×¨×” ×—×©×‘×•× ×™×ª';
      const amount = document.getElementById('rec_amount').value;
      const currency = document.getElementById('rec_currency').value;
      const paymentMethod = document.getElementById('rec_paymentMethod').value || '×××¦×¢×™ ×ª×©×œ×•×';
      const date = document.getElementById('rec_date').value || new Date().toISOString().split('T')[0];
      const formattedDate = date.split('-').reverse().join('/');

      // Get invoice details
      const customerName = selectedInvoice?.customerName || '×©× ×”×œ×§×•×—';
      const invoiceDescription = selectedInvoice ? `×—×©×‘×•× ×™×ª ${selectedInvoice.invoiceNumber} - ${selectedInvoice.description || ''}` : '×ª×™××•×¨';
      const totalAmount = selectedInvoice?.amount || 0;
      const currentRemainingBalance = selectedInvoice?.remainingBalance || 0;

      // Calculate new remaining balance after this payment
      const currentPayment = parseFloat(amount) || 0;
      const newRemainingBalance = Math.max(0, currentRemainingBalance - currentPayment);

      return `
        <div class="doc-header">
          <div class="business-info">
            <div class="business-name">${BUSINESS_NAME || '×©× ×”×¢×¡×§'}</div>
            <p>${BUSINESS_TAX_STATUS || '×¢×•×¡×§ ×¤×˜×•×¨ ××¡'}: ${BUSINESS_TAX_ID || '×—.×¤ / ×¢.×'}</p>
            <p>${BUSINESS_EMAIL || '××™××™×™×œ'}</p>
            <p>×›×ª×•×‘×ª: ${BUSINESS_ADDRESS || '×›×ª×•×‘×ª'}</p>
            <p>${BUSINESS_PHONE || '×˜×œ×¤×•×Ÿ'}</p>
          </div>
          ${getBusinessLogoHtml()}
        </div>

        <div class="title-bar">×§×‘×œ×” / ××¡×³ [×™×•×§×¦×” ××•×˜×•××˜×™×ª]</div>

        <div class="meta-section">
          <div><span style="color: #666;">×¢×‘×•×¨: </span><strong>${customerName}</strong></div>
          <div><span style="color: #666;">××§×•×¨: </span>×—×©×‘×•× ×™×ª ××¡×¤×¨ ${invoiceNumber}</div>
          <div><span style="color: #666;">×ª××¨×™×š: </span><strong>${formattedDate}</strong></div>
        </div>

        <div style="padding: 12px 0; margin-bottom: 20px;">
          <div style="font-size: 14px; color: #333; text-align: right; margin-bottom: 4px;">
            ××¡××š ×–×” ××§×•×©×¨ ×œ×—×©×‘×•× ×™×ª
          </div>
          ${selectedInvoice ? `
            <div style="font-size: 13px; color: #666; line-height: 1.6; text-align: right;">
              <div>××¡×¤×¨ ×—×©×‘×•× ×™×ª: ${invoiceNumber} | ×ª××¨×™×š: ${selectedInvoice.date}</div>
              <div>×¡×›×•× ×—×©×‘×•× ×™×ª: ${formatAmount(totalAmount, currency)}</div>
              <div>×™×ª×¨×” × ×•×›×—×™×ª: ${formatAmount(currentRemainingBalance, currency)}</div>
              <div>×™×ª×¨×” ×œ××—×¨ ×ª×©×œ×•×: ${formatAmount(newRemainingBalance, currency)}</div>
            </div>
          ` : ''}
        </div>

        <div style="margin: 15px 0;">
          <div style="font-weight: 600; margin-bottom: 8px;">×¤×¨×˜×™ ×ª×©×œ×•×:</div>
          <table class="items-table">
            <thead>
              <tr>
                <th>×¡×•×’ ×ª×©×œ×•×</th>
                <th>×¤×¨×˜×™×</th>
                <th>×ª××¨×™×š</th>
                <th>×¡×”×´×›</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${paymentMethod}</td>
                <td></td>
                <td>${formattedDate}</td>
                <td class="amount">${formatAmount(amount, currency)}</td>
              </tr>
              <tr class="total-row">
                <td colspan="3" style="text-align: center; font-weight: 700;">×¡×”×´×› ×©×•×œ×</td>
                <td class="amount">${formatAmount(amount, currency)}</td>
              </tr>
            </tbody>
          </table>
        </div>

        ${newRemainingBalance > 0 ? `
        <div style="padding: 12px 0; margin: 20px 0;">
          <div style="font-size: 14px; color: #333; text-align: right;">×™×ª×¨×” ×œ×ª×©×œ×•×: <span style="font-weight: 600;">${formatAmount(newRemainingBalance, currency)}</span></div>
        </div>
        ` : `
        <div style="padding: 12px 0; margin: 20px 0;">
          <div style="font-size: 14px; color: #333; text-align: right;">×©×•×œ× ×‘××œ×•××•</div>
        </div>
        `}

        <div class="footer">
          <div>×ª××¨×™×š ×”×¤×§×”: ${formattedDate}</div>
          <div style="text-align: left;">
            <div style="font-weight: 600; color: #333;">××¡××š ×××•×—×©×‘ ×—×ª×•× ×“×™×’×™×˜×œ×™×ª</div>
            <div>×”×•×¤×§ ×¢"×™ Invofox</div>
          </div>
        </div>
      `;
    }

    function generateInvoiceReceiptPreview() {
      const customerName = document.getElementById('invr_customerName').value || '×©× ×”×œ×§×•×—';
      const customerTaxId = document.getElementById('invr_customerTaxId').value || '0';
      const description = document.getElementById('invr_description').value || '×ª×™××•×¨ ×”×©×™×¨×•×ª';
      const amount = document.getElementById('invr_amount').value;
      const currency = document.getElementById('invr_currency').value;
      const paymentMethod = document.getElementById('invr_paymentMethod').value || '×××¦×¢×™ ×ª×©×œ×•×';
      const date = document.getElementById('invr_date').value || new Date().toISOString().split('T')[0];
      const formattedDate = date.split('-').reverse().join('/');

      return `
        <div class="doc-header">
          <div class="business-info">
            <div class="business-name">${BUSINESS_NAME}</div>
            <p>${BUSINESS_TAX_STATUS}: ${BUSINESS_TAX_ID}</p>
            <p>${BUSINESS_EMAIL}</p>
            <p>×›×ª×•×‘×ª: ${BUSINESS_ADDRESS}</p>
            <p>${BUSINESS_PHONE}</p>
          </div>
          ${getBusinessLogoHtml()}
        </div>

        <div class="title-bar">×—×©×‘×•× ×™×ª-×§×‘×œ×” / ××¡×³ [×™×•×§×¦×” ××•×˜×•××˜×™×ª]</div>

        <div class="meta-section">
          <div><span style="color: #666;">×¢×‘×•×¨:</span></div>
          <div><span style="color: #666;">××§×•×¨</span></div>
          <div><span style="color: #666;">×ª××¨×™×š: </span><strong>${formattedDate}</strong></div>
        </div>

        <div class="customer-info">
          <div class="customer-name">×©×: ${customerName}</div>
          <div style="font-size: 11px; color: #666;">×¢×•×¡×§ ××¡×³: ${customerTaxId}</div>
        </div>

        <table class="items-table">
          <thead>
            <tr>
              <th>×ª×™××•×¨</th>
              <th>×›××•×ª</th>
              <th>××—×™×¨ ×œ×™×—×™×“×”</th>
              <th>×¡×”×´×›</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${description}</td>
              <td>1</td>
              <td>${formatAmount(amount, currency)}</td>
              <td class="amount">${formatAmount(amount, currency)}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: center; font-weight: 700;">×¡×”×´×› ×œ×ª×©×œ×•×</td>
              <td class="amount">${formatAmount(amount, currency)}</td>
            </tr>
          </tbody>
        </table>

        <div style="padding: 12px 0; margin: 20px 0;">
          <div style="font-size: 14px; color: #333; text-align: right;">×©×•×œ× ×‘××œ×•××• - ×××¦×¢×™ ×ª×©×œ×•×: ${paymentMethod}</div>
        </div>

        <div class="footer">
          <div>×ª××¨×™×š ×”×¤×§×”: ${formattedDate}</div>
          <div style="text-align: left;">
            <div style="font-weight: 600; color: #333;">××¡××š ×××•×—×©×‘ ×—×ª×•× ×“×™×’×™×˜×œ×™×ª</div>
            <div>×”×•×¤×§ ×¢"×™ Invofox</div>
          </div>
        </div>
      `;
    }

    function updatePreview() {
      console.log('Updating preview for:', selectedDocType);

      if (selectedDocType === 'invoice') {
        const previewEl = document.getElementById('invoice-preview');
        if (previewEl) {
          previewEl.innerHTML = generateInvoicePreview();
        }
      } else if (selectedDocType === 'receipt') {
        const previewEl = document.getElementById('receipt-preview');
        if (previewEl) {
          previewEl.innerHTML = generateReceiptPreview();
        }
      } else if (selectedDocType === 'invoice_receipt') {
        const previewEl = document.getElementById('invoice_receipt-preview');
        if (previewEl) {
          previewEl.innerHTML = generateInvoiceReceiptPreview();
        }
      }
    }

    // Add event listeners to all form inputs
    function setupPreviewListeners() {
      // Invoice form
      ['inv_customerName', 'inv_customerTaxId', 'inv_description', 'inv_amount', 'inv_currency', 'inv_date'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updatePreview);
          element.addEventListener('change', updatePreview);
        }
      });

      // Receipt form (rec_invoiceNumber and rec_customer are handled separately)
      ['rec_amount', 'rec_currency', 'rec_paymentMethod', 'rec_date'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updatePreview);
          element.addEventListener('change', updatePreview);
        }
      });

      // Invoice-Receipt form
      ['invr_customerName', 'invr_customerTaxId', 'invr_description', 'invr_amount', 'invr_currency', 'invr_paymentMethod', 'invr_date'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updatePreview);
          element.addEventListener('change', updatePreview);
        }
      });
    }

    // Initial preview render
    updatePreview();
  </script>
</body>
</html>
